# Сервисы

**Сервисы** являются основной точкой расширения для инфраструктуры Exonum.
По сути Exonum предоставляет набор строительных элементов для создания
блокчейна; он не содержит никаких конкретных правил обработки транзакций.
Для этого как раз и нужны сервисы: используйте их для создания собственного
блокчейна Exonum.

## Обзор

Подобно смарт-контрактам на некоторых других блокчейн платформах, сервисы Exonum
инкапсулируют бизнес-логику блокчейн приложения.

- Сервис определяет **правила обработки транзакций**, а именно то, как
  [транзакции](transactions.md) влияют на состояние сервиса  
- Состояние сервиса, преобразованное транзакциями, **сохраняется** как часть
  общего [блокчейн хранилища](https://exonum.com/doc/architecture/storage/)
- Сервис также может позволять [внешним клиентам](clients.md)
  **считывать соответствующие данные** из текущего состояния блокчейна  

Каждый сервис имеет четко определенный интерфейс для связи с внешним миром,
который по сути представляет собой набор конечных точек, и реализацию
упомянутого интерфейса. В таком виде сервисы могут считывать и записывать
данные из состояния блокчейна (обычно для простоты управления данными
реализуется схема, которая в свою очередь является интерфейсом для доступа к
хранилищу), а также обращаться к локальной конфигурации узла.

Сервисы выполняются каждым валидатором и аудитром в блокчейн сети. Порядок
обработки транзакций и результирующие изменения состояния сервиса являются
частью [алгоритма консенсуса](consensus.md). Они гарантированно будут
одинаковыми для всех узлов в блокчейн сети.

!!! note "Примечание"
    В отличие от смарт-контрактов в некоторых блокчейнах, сервисы в Exonum не
    изолированы внутри виртуальной машины или контейнера. Это делает сервисы
    Exonum более эффективными и гибкими в своих возможностях, но в то же время
    требует более тщательной программной реализации. Изоляция сервисов включена
    в [дорожную карту](https://exonum.com/doc/roadmap/) Exonum.

## Интерфейс сервисов

Для связи с внешними объектами сервисы используют три вида конечных точек:

- [Транзакции](#транзакции)
- [Запросы на чтение](#запросы-на-чтение) (совместно с транзакциями формируют
  публичный API)
- [Приватный API](#приватный-api)

Конечные точки сервиса автоматически группируются и координируются промежуточным
слоем Exonum.

!!! note "Примечание"
    Exonum использует [фреймворк Iron][iron] для определения конечных точек
    сервиса, как публичных, так и приватных. Конечные точки публичного и
    приватного API обслуживаются на разных сокетах, что позволяет задавать более
    строгие правила брандмауэра для приватных API.

### Транзакции

Транзакции поступают от объектов, внешних по отношению к блокчейну, например,
от [легких клиентов](clients.md). Глобально, транзакция изменяет состояние
блокчейна при условии, что она считается «правильной». Все транзакции
записываются в блокчейн как часть журнала транзакций. Как следует из названия,
транзакции [атомарны][wiki:atomicity]; они упорядочены строго определенным
образом и выполняются одинаково на всех узлах.

В терминах REST служб транзакции соответствуют `POST` и `PUT`
HTTP-методам. Транзакции являются асинхронными в том смысле, что автор
транзакции не получает немедленного ответа относительно результата транзакции.
Это невозможно ввиду особенностей работы алгоритма консенсуса в
блокчейнах; транзакция попадает в блокчейн не сразу, а вместе с другими
транзакциями в виде блока.

!!! note "Пример"
    Перевод средств &mdash; это классический пример транзакции в блокчейне.
    Транзакция содержит поля, которые соответствуют публичным ключам
    отправителя и получателя, а также сумме переданных средств. Кроме того,
    транзакция содержит цифровую подпись,
    созданную при помощи приватного ключа отправителя. Больше информации по
    данному вопросу можно найти в [руководстве по созданию сервиса](https://exonum.com/doc/get-started/create-service.md)

### Запросы на чтение

Запросы на чтение являются аналогами const методов в C++ или
`GET` запросов в парадигме REST. Они не могут изменять состояние блокчейна
и не записываются в блокчейн. В отличие от транзакций, запросы на чтение не
являются частью алгоритма консенсуса; они обрабатываются локально тем узлом,
который получил данный запрос.

Одной из отличительных особенностей фреймворка Exonum является то, что он
обеспечивает богатый набор инструментов, позволяющий снабжать ответы на запросы
на чтение криптографическими доказательствами. Доказательства позволяют легким
клиентам свести к минимуму необходимость слепого доверия отвечающему узлу. По
сути, полученный ответ настолько же достоверный, как и тот, который бы он
получил, если бы опросил абсолютное большинство валидаторов блокчейна.

!!! summary "Примечание"
    В терминах криптографии доказательство раскрывает [привязку][wiki:crypto-commit]
    к данным в блокчейне, которая реализована в виде сохранения хеша состояния
    сети в заголовке блока. Использование деревьев Меркла позволяет сделать
    доказательства достаточно компактными, чтобы их могли обработать легкие
    клиенты.

### Приватный API

В отличие от транзакций и запросов на чтение, вызовы приватного API обозначают
взаимодействие сервиса не с внешними клиентами, а с администратором
узла Exonum, на котором выполняется сервис. Приватный API не должен
быть доступным из внешнего мира.

Подобно запросам на чтение приватные API не могут изменять состояние блокчейна,
однако они могут создавать транзакции и транслировать их в сеть.

!!! note "Пример"
    В [сервисе обновления конфигурации](https://exonum.com/doc/configuration-updater.md)
    приватный API используется для получения информации о текущей конфигурации
    и для отправки предложений обновления конфигурации.

## Детали реализации

### Схема данных

Обычно сервис хранит какие-то данные. Например, тестовый
сервис криптовалюты сохраняет балансы счетов, которые могут быть изменены
посредством осуществления транзакций передачи средств и пополнения счета.

Exonum сохраняет состояние блокчейна в глобальном хранилище типа ключ-значение,
реализованном с помощью [RocksDB][rocksdb]. Каждый сервис должен определить
набор типов данных (*таблицы*), в которых он будет хранить данные, относящиеся к
нему; эти таблицы абстрагируют потребность сервиса напрямую взаимодействовать с
хранилищем блокчейна. К встроенныем коллекциям данных, поддерживаемых Exonum
относятся карты (`MapIndex`), множества (`ValueSetIndex`, `KeySetIndex`) и
списки (`ListIndex`).

Exonum также предоставляет вспомогательные механизмы для меркелизированных
коллекций данных на основе *деревьев Меркла*, которые позволяют эффективно вычислять
доказательства
в ответ на запросы на чтение, относящиеся к отдельным элементам таких коллекций.
Версиями карт и списков на основе деревьев Меркла являются `ProofMapIndex` и
`ProofListIndex` соответственно.

Естественным образом, элементы коллекций (и ключей в случае карт) должны быть
сериализуемыми. Exonum обеспечивает простой и надежный
[бинарный формат сериализации](https://exonum.com/doc/architecture/serialization/),
и соответствующий набор инструментов для (де)сериализации и преобразования
типов данных Exonum в JSON для обеспечения взаимодействия с легкими клиентами.

### Конфигурация

Сервисы могут использовать [конфигурацию](https://exonum.com/doc/architecture/configuration.md)
для хранения параметров, которые будут получены конструктором сервиса во время
[инициализации узла](#инициализация). Конфигурация состоит из двух частей:
*глобальной конфигурации*, которая хранится в блокчейне, и
*локальной конфигурации*, которая является индивидуальной для каждого отдельного
узла.

#### Глобальная конфигурация

Глобальная конфигурация является общей для всех узлов в блокчейн сети.
Примером параметра глобальной конфигурации является адрес анкоринга
в [сервисе анкоринга](https://exonum.com/doc/advanced/bitcoin-anchoring.md).
Адрес анкоринга является общим для всех узлов в блокчейн сети, его изменения
должны быть отслеживаемыми и авторизованы определенными узлами.

Глобальная конфигурация регулируется системными администраторами
через [сервис обновления конфигурации](https://exonum.com/doc/advanced/configuration-updater.md).
С точки зрения сервиса глобальная конфигурация является *подвижной*:
она может быть изменена не затрагивая конечные точки сервиса.
Сервис может просматривать текущую глобальную конфигурацию при помощи
[специальных методов][core-schema.rs] API ядра.

#### Локальная конфигурация

Локальная конфигурация индивидуальна для каждого отдельного узла.
Примером параметра локальной конфигурации является приватный ключ для
анкоринга, который используется в [сервисе анкоринга](https://exonum.com/doc/advanced/bitcoin-anchoring.md).
Естественным образом, узлы имеют разные приватные ключи. Их нельзя хранить
в блокчейне из соображений безопасности.

Локальная конфигурация может быть изменена путем редактирования файла локальной
конфигурации узла. Единственный способ для сервиса в Exonum получить доступ к
локальной конфигурации &mdash; это сохранить ее после того,
как она была передана конструктору сервиса во время
[инициализации сервиса](#инициализация).

## Жизненный цикл

Жизненный цикл сервиса вклчюает следующие важные события.

### Развертывание

В самом начале жизненного цикла сервис регистрируется
в блокчейне. Во время развертывания сервис создает начальную
конфигурацию и инициализирует свое постоянное хранилище.

!!! note "Примечание"
    Начиная с версии Exonum 0.1, сервисы могут быть развернуты только во время
    инициализации блокчейна (то есть до того, как блокчейн сеть начнет
    создавать какие-либо блоки). В будущем сервисы будут развертываться
    динамически как библиотеки.

### Инициализация

При каждом запуске узла-валидатора или аудитора, он инициализирует все
действущие сервисы. Инициализация передает локальную и глобальную
конфигурацию блокчейна сервису, чтобы правильно инициализировать его
состояние. При обновлении конфигурации сервисы автоматически перезапускаются.

### Обработка транзакций

Сервис отвечает за проверку структурной целостности входящих
транзакций и выполнение транзакций (т.е. применение их к состоянию блокчейна).
Транзакции выполняются на этапе [precommit](consensus.md) алгоритма консенсуса
(это касается только валидаторов), или когда узел получает блок.

### Обработка событий

Сервисы могут подписываться на события (например, принятие блока) и выполнять
некоторую работу в обработчике событий. Обработчики событий не могут изменять
состояние блокчейна, но могут быть использованы для различных задач, таких как
ведение журнала событий, миграция данных, обновление локальных параметров
и/или генерирование и транслирование транзакций в блокчейн сеть.

!!! note "Примечание"
    Начиная с версии Exonum 0.1, единственным встроенным событием является
    принятие блока. В будущем будут добавлены и другие события:
    сервисы смогут определять и создавать события, а также сервисы и легкие
    клиенты смогут подписываться на события, создаваемые сервисами.

## Разработка сервиса

!!! note "Примечание"
    Сервисы можно писать на языках программирования [Rust](http://rust-lang.org/) и Java.

Ниже приведен список вопросов, на которые необходимо ответить прежде, чем
приступать к разработке сервисами Exonum:

- Какие действия будет выполнять сервис? Какие изменяемые параметры содержат эти
  действия? (Данный ответ определяет конечные точки сервиса)
- Кто будет авторизовать каждое из этих действий? (Возможно, вы захотите
  использовать инфраструктуру открытых ключей для серьезных приложений, чтобы
  обеспечить полную децентрализацию безопасности блокчейна)
- Какие данные будет хранить сервис? Каковы основные их сущности? Как эти
  сущности организованы в коллекции данных (карты и списки только с возможностью
  добавления)?
- Существуют ли отношения по внешнему ключу между хранимыми сущностями? (Модель
  данных Exonum поддерживает отношения между сущностями через хэш-ссылки, более
  подробную информацию см. в разделе по организации истории кошелька в
  [руководстве по созданию сервиса криптовалюты](https://exonum.com/doc/get-started/create-service.md))
- Какие перманентные данные будут возвращаться внешним клиентам? (Возможно, вы
  захотите использовать меркелизованные коллекции данных для этих целей и
  создать соответствующие конечные точки для запросов на чтение)
- Существуют ли какие-либо задачи по поддержанию сервиса? Будут ли задачи
  вызываться автоматически или с разрешения системных администраторов? (Эти
  задачи могут быть реализованы в обработчике событий принятия блока в данном
  сервисе или в виде конечных точек приватного API)
- Какие параметры требуются для задач поддержания сервиса? Являются ли эти
  параметры локальными для каждого узла, на котором работает сервис, или они
  должны быть согласованы с админитраторами блокчейна? (Ответ определяет, должен
  ли параметр быть частью локальной конфигурации или он может храниться в
  блокчейне)

!!! tip "Совет"
    В [руководстве по созданию сервиса криптовалюты](https://exonum.com/doc/get-started/create-service.md)
    представлена пошаговая инструкция по созданию сервиса Exonum, который
    реализует минималистический крипто-токен.

### Ограничения

Начиная с версии Exonum 0.1, существуют некоторые временные ограничения на то,
что вы можете реализовать c помощью сервисов Exonum. Пожалуйста, ознакомьтесь с
[дорожной картой Exonum](https://exonum.com/doc/roadmap/) для получения
информации о том, когда и как данные ограничения будут устранены.

#### Взаимодействие между сервисами

В Exonum нет единого API для сервисов, по которому они могли бы обращаться к
конечным точкам других сервисов. Например, сервис не может вызвать транзакцию,
определенную в другом сервисе, а также не может считывать данные из другого
сервиса через его конечную точку для чтения.

#### Средство аутентификации

В отличие от большинства веб-фреймворков, Exonum не обеспечивает промежуточный
слой для аутентификации конечных точек обслуживания. Таким образом, реализация
аутентификации и авторизации является обязанностью разработчика сервиса.

## Полезные советы

### Взаимодействие с внешним миром

Сервисы могут обращаться к внешнему миру (считывать и делать записи в файлы из
файловой системы, отправлять/получать данные из сети и т.д.), однако такое
взаимодействие осуществляется только в коде за пределами консенсуса (т.е. в
коде, который во время выполнения транзакций не исполняется). Подходящим местом
для такого кода являются обработчики событий.

!!! note "Пример"
    [Реализация сервиса анкоринга](https://github.com/exonum/exonum-btc-anchoring)
    использует обработчик событий принятия нового блока для связи с
    сетью Биткоин блокчейна.

### Сервисы vs смарт-контракты

Сервисы «больше», чем смарт-контракты в Ethereum. Например, в Ethereum
контракты с множественными подписями создаются для каждой конкретной
конфигурации участников; в Exonum весь функционал множественных подписей
может содержаться в одном сервисе. Это делает сервисы более удобными в
обращении и улучшает производительность и управление контролем доступа.

### Интерфейс транзакций

Транзакции в Exonum являются отдельными сущностями, а не типами данных,
потребляемыми методами сервисных объектов. Сначала это может показаться сложным,
но это делает обработку транзакций более гибкой. Например, становится возможным
(и есть планы по реализации данной идеи) добавить управление упорядочиванием
транзакций, находящихся в пуле неподтвержденных транзакций, через дополнительный
метод интерфейса транзакции.

### Особенности обработки транзакций

При программировании сервиса следует иметь в виду, что сервис может
обрабатывать транзакции как в реальном времени, так и ретроспективно (например,
в случае когда узел выполняет начальную синхронизацию блокчейна). Это еще одна
причина не использовать источники данных, не относящиеся к блокчейну, в коде
обработки транзакций &mdash; в последствии может быть трудно все время поддерживать их
синхронизацию.

Кроме того, имейте в виду, что сервисы могут работать как на узлах-валидаторах,
так и на аудиторах. Следовательно, рекомендуется сделать всю секретную
информацию, используемую в локальной конфигурации
(например, приватные ключи) необязательной; в таком случае узел, на котором
запущен сервис, может и не знать этой информации.

[iron]: http://ironframework.io/
[wiki:atomicity]: https://en.wikipedia.org/wiki/Atomicity_(database_systems)
[rocksdb]: http://rocksdb.org
[service.rs]: https://github.com/exonum/exonum/blob/master/exonum/src/blockchain/service.rs
[core-schema.rs]: https://github.com/exonum/exonum/blob/master/exonum/src/blockchain/schema.rs
