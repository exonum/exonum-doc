# Сервис анкоринга

<!-- cspell:ignore bitcoind,lects,txid,utxo,utxos -->

Сервис анкоринга делает приложения на базе Exonum более безопасными и
отказоустойчивыми. Этот сервис периодически публикует хеш
блока блокчейна Exonum в Биткоин-блокчейн, чтобы любой, кто имеет доступ к
блокчейну Exonum, имел возможность его проверить. Даже в случае сговора
валидаторов историю транзакций невозможно сфальсифицировать. Несоответствие
между фактическим состоянием блокчейна Exonum и тем, которое записано в
Биткоин-блокчейн, будет мгновенно обнаружено.

!!! note "Примечание"
    Данный документ в основном описывает принцип работы сервиса. Описание
    [процесса настройки и развертывания][anchoring-deploy] сервиса представлено
    в отдельном документе, исходный код которого находится на [GitHub][github-anchoring].

## Общий принцип

Сервис записывает хеш последнего блока Exonum в постоянное хранилище, доступное
только для чтения. Такой блок называется _анкорящим блоком_, а его
хеш _анкорящим хешем_.

Сервис создает _анкорящую цепочку_ поверх Биткоин-блокчейна, другими словами,
цепочка состоит из множества _анкорящих транзакций Биткоина_. Каждая анкорящая
транзакция имеет как минимум 1 вход и только 2 выхода: выход данных и выход
остатка баланса. Выход данных содержит сохраненный анкорящий хеш, в то время
как выход остатка баланса возвращает оставшиеся деньги на Биткоин-адрес
анкоринга, чтобы они могли быть ипользованы для осуществления следующей
анкорящей транзакции.

```None
             пополнение
             баланса tx
                        \
      tx1        tx2     \   tx3        tx4
.. --> остаток --> остаток --> остаток --> остаток --> ..
   \           \           \           \
    -> данные   -> данные   -> данные   -> данные
```

В анкорящей транзакции иногда используются дополнительные входы, называемые
непотраченными выходами транзакции для пополнения баланса
([UTXO пополнения баланса](#funding-utxo)).
Такие входы необходимы для пополнения баланса анкорящей цепочки, который
расходуется на комиссию для осуществления транзакций.

## Анкорящие транзакции

### Multisig-адрес как метод децентрализации

Децентрализация в процессе анкоринга построена на внутренней архитектуре
Биткоин-адресов с множественными подписями (multisig-адреса).

В момент, когда сеть Exonum должна быть заанкорена, каждый валидатор строит
анкорящую транзакцию с использованием
[детерминированного алгоритма](#создание-анкорящей-транзакции).
Его результаты гарантировано совпадут для каждого честного валидатора. Эта
анкорящая транзакция тратит один или несколько UTXO из текущего анкорящего
multisig-адреса. Каждый валидатор может подписать эту транзакцию без участия
других валидаторов, поскольку это допускается Биткоин-сетью. Все подписи
публикуются в блокчейне Exonum.

Exonum использует multisig-адреса `M из N`, где `N` &mdash; число анкорящих
валидаторов  (`N <= 20` из-за ограничений в сети Биткоин), а `M` &mdash;
необходимое количество подписей. В консенсусе Exonum `M = floor(2/3*N) + 1`
используется как абсолютное большинство.

!!! note "Примечание"
    Допустим, имеется `N=10` валидаторов, тогда `M=7` представляет собой
    абсолютное большинство. Это означает, что для создания анкорящей транзакции
    требуется 7 подписей. Если же `N=4`, то требуется `M=3` подписей.

После публикации необходимого количества подписей любой узел-участник может
создать правильную и подписанную анкорящую транзакцию и передать ее в
Биткоин-блокчейн.

### Изменяемость транзакций

Подписи валидаторов записаны в блокчейне Exonum в открытом виде; при этом может
быть опубликовано более `M` подписей (достаточно частое явление).
Существует отдельный алгоритм, который строго определенным образом из них
отбирает `М` подписей.

Однако любой византийский узел может отклониться от детерминированного
алгоритма и использовать другой список подписей для анкорящей транзакции.
Этот узел может создать транзакцию с тем же анкорящим хешем
(тот же вывод данных), но с другим ID транзакции (tx-id), и передать его
в сеть Биткоин. Такие нестандартные транзакции представляют собой проблему,
потому что новые анкорящие транзакции могут формироваться, даже если более
старые транзакции еще не были включены в Биткоин-блокчейн.
При этом есть вероятность, что более старая транзакция или один из ее предков
были мутированы византийским валидатором, как описано выше, и мутировавшая
транзакция была записана в Биткоин-блокчейн. При таких условиях исходная
транзакция становится некорректной и более не может быть включена в
Биткоин-блокчейн.

Для разрешения этой проблемы выбор соответствующей предыдущей транзакции
[LECT](#lect) происходит на основе консенсуса.

### LECT

Каждый валидатор определяет, какая анкорящая транзакция считается актуальной.
Эта
транзакция должна быть потрачена в новой анкорящей транзакции и называется
актуальной ожидаемой корректной транзакцией (LECT). LECT всех валидаторов
публикуются в блокчейне Exonum. При создании новой анкорящей транзакции
абсолютное большинство валидаторов выбирает общую LECT и тратит ее выход
остатка баланса.

Каждый валидатор обновляет свою LECT по
[специальному расписанию](#lect-updating-interval).
Чтобы получить новую LECT, валидатор использует API
[узла Биткоина](#bitcoind-node).
Новая LECT должна обладать следующими свойствами:

- Это действительная анкорящая транзакция для текущего блокчейна Exonum;
- Она может иметь любое количество подтверждений, в частности, 0;
- Ее выход остатка баланса должен быть неизрасходованным. Это означает, что
  указанный валидатор считает, что после данной LECT не было других анкорящих
  транзакций;
- Среди всех Биткоин-транзакций, удовлетворяющих выше перечисленным свойствам,
  LECT должна иметь наибольшую высоту анкорящего блока блокчейна Exonum;
- Если несколько транзакций соответствуют предыдущим требованиям, любая из них
  может быть выбрана как LECT.

LECT решает проблему изменяемости транзакций. Вместе с тем, анкорящие
транзакции по-прежнему могут осиротеть из-за включения в блокчейн
альтернативной родительской транзакции;
такие транзакции никогда не будут записаны в Биткоин-блокчейн.
Тем не менее, эта система достаточно безопасна, поскольку последующие
анкорящие транзакции в действительности анкорят и все предыдущие
(т.к. хеш блока более поздней анкорящей транзакции зависит от хеша
блока осиротевшей транзакции).

### Детальная структура предложения анкорящей транзакции

Предложение анкорящей транзакции строится следующим образом:

- Оно соответствует спецификации Биткоин-транзакции.
- Входы транзакции включают в себя:

    - Выход остатка баланса общей выбранной LECT. Этот вход присутствует в
      каждой анкорящей транзакции, кроме первой.
    - UTXO пополнения баланса, записанный в глобальной конфигурации (если он
      еще не потрачен).

- Выходы транзакции содержат выход данных и выход остатка баланса. Сначала
  идет выход остатка баланса, а следом &mdash; выход данных.
- Его выход данных содержит одну инструкцию `OP_RETURN` с анкорящими данными.
  Такие данные состоят из нескольких [фрагментов данных](#фрагменты-данных)
- Его выход остатка баланса перенаправляет средства на следующий анкорящий
  адрес, если анкорящий адрес [должен быть изменен](#changing-validators-list).
  В противном случае используется текущий адрес.

### Фрагменты данных

Выход данных состоит из следующих частей:

- инструкция OP_RETURN (`0x6a`)
- 1 байт, содержащий число, соответствующее длине данных в скрипте
- `EXONUM` в кодировке ASCII (`0x45 0x58 0x4f 0x4e 0x55 0x4d`)
- 1-байтная версия текущего вывода данных, в настоящее время `1`
- 1-байтный тип полезной нагрузки: 0, если включен только анкорящий хеш, 1,
  если используются оба фрагмента
- 40 байт фрагмента данных анкорящего хеша
- (опционально) фрагмент данных для восстановления анкорящей цепочки размером
  32 байта

Все целочисленные фрагменты представлены в виде порядка байт от младшего к
старшему в соответствии с общими принципами языка сценариев Биткоин-блокчейна.

В целом полезная нагрузка анкорящей транзакции обычно занимает 48 байт и
увеличивается до 80 байт при необходимости восстановления.

#### Фрагмент данных анкорящего хеша

- 8-байтная беззнаковая высота анкорящего блока (то есть высота генезис-блока
  равна `0`), которая может использоваться для эффективного поиска.
- 32-байтный хеш блока

#### Фрагмент данных для восстановления анкорящей цепочки

Указанный фрагмент представляет собой 32-байтный хеш Биткоин-транзакции.
Этот хеш показывает, что текущая анкорящая цепь является продолжением ранее
прерванной анкорящей цепи. Возможные причины таких остановок описаны в
[оригинальном документе](#transitional-transaction).

Фрагмент данных для воссотановления цепи является необязательным и может
отображаться в самой
первой анкорящей Биткоин-транзакции только в случае, если предыдущая анкорящая
цепочка оборвалась (как описано в разделе
[Восстановление предыдущей цепочки](#recovering-broken-anchoring)).

### Создание анкорящей транзакции

- Допустим, `H` &mdash; высота блока, который должен быть заанкорен
- Начиная с этого блока `#H`, каждый валидатор контролирует список
  текущих LECT. Появление общей LECT (которая определяется `+2/3` валидаторов),
  означает, что **предложение анкорящей транзакции** (анкорящая транзакция
  без подписей валидаторов) считается полностью определенным
  и согласованным `+2/3` валидаторов.
- После появления общей LECT, каждый валидатор строит анкорящую транзакцию и
  подписывает каждый ее вход
- Подписи публикуются в блокчейне Exonum
- На основе подписей _любой_ узел Exonum может создавать анкорящую транзакцию
  и транслировать ее в сеть Биткоин. В частности, она транслируется всеми
  валидаторами, которые согласились с выбранной LECT.

#### Пропуск анкоринга

Если подошло время блокчейну Exonum выполнить анкоринг, но LECT не согласована
с `+2/3` валидаторов, то анкоринг не выполняется. Сервис анкоринга ждет, пока
некоторые валидаторы не обновят свою анкорящую цепочку, и общая LECT не будет
обнаружена. Новый блок для анкоринга &mdash; это крайний блок блокчейна Exonum,
который
должен быть заанкорен. Например, блокчейн Exonum находится на высоте `#11000` с
интервалом привязки `1000` блоков. Если общая LECT появляется на высоте
`#12345`, блок `#12000` анкорится, хотя для блока `#11000` анкоринг не
состоится.

[anchoring-deploy]: https://github.com/exonum/exonum-btc-anchoring/blob/master/DEPLOY.md
[anchoring-parameters]: https://github.com/exonum/exonum-btc-anchoring/blob/master/DEPLOY.md#change-configuration-parameters
[github-anchoring]: https://github.com/exonum/exonum-btc-anchoring
[bitcoind]: https://bitcoin.org/en/bitcoin-core/
